generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model users {
  id           String    @id @default(uuid())
  username     String    @unique
  password_hash String
  role         String
  is_active    Boolean   @default(true)
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  face_descriptor String?

  employee     employees?

  attendance_corrections attendance_corrections[] @relation("user_corrections")
  payroll_periods_locked  payroll_periods[] @relation("user_locked_periods")
  approved_leave_requests leave_requests[] @relation("user_approvals_leave")
  approved_overtime_requests overtime_requests[] @relation("user_approvals_overtime")
}

model employees {
  id            String    @id @default(uuid())
  user_id       String    @unique
  employee_code String?
  name          String
  category      String
  is_active     Boolean   @default(true)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  user          users     @relation(fields: [user_id], references: [id])

  attendance    attendance[]
  leave_requests leave_requests[]
  leave_balances leave_balances[]
  overtime_requests overtime_requests[]
  payrolls        payrolls[]
  notifications   notifications[]
}

model attendance {
  id                 String          @id @default(uuid())
  employee_id        String
  attendance_date    DateTime
  check_in_time      DateTime?
  check_out_time     DateTime?
  check_in_location  String?
  check_out_location String?
  check_in_photo     String?
  check_out_photo    String?
  late_minutes       Int             @default(0)
  status             String
  created_at         DateTime        @default(now())
  updated_at         DateTime        @updatedAt

  employee           employees       @relation(fields: [employee_id], references: [id])

  attendance_corrections attendance_corrections[]

  @@index([employee_id, attendance_date])
}

model attendance_corrections {
  id                    String   @id @default(uuid())
  attendance_id         String
  corrected_by_user_id  String
  field_name            String
  before_value          String?
  after_value           String?
  reason                String
  created_at            DateTime @default(now())

  attendance            attendance @relation(fields: [attendance_id], references: [id])
  corrected_by_user     users      @relation("user_corrections", fields: [corrected_by_user_id], references: [id])
}

model leave_types {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  description String?
  max_days    Int
  requires_doc Boolean  @default(false)
  color       String   @default("#6366f1")
  is_active   Boolean  @default(true)
  
  leave_requests leave_requests[]
  leave_balances leave_balances[]
  
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
}

model leave_requests {
  id            String      @id @default(uuid())
  request_number String      @unique
  
  employee_id   String
  employee      employees    @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  
  leave_type_id String
  leave_type    leave_types  @relation(fields: [leave_type_id], references: [id])
  
  start_date    DateTime
  end_date      DateTime
  total_days    Int
  reason        String
  
  status        String      @default("PENDING")
  submitted_at  DateTime    @default(now())
  reviewed_at   DateTime?
  reviewed_by   String?
  review_notes  String?
  
  attachment_url String?
  
  attendances_synced Boolean @default(false)
  
  created_at    DateTime    @default(now())
  updated_at    DateTime    @updatedAt

  approver      users?      @relation("user_approvals_leave", fields: [reviewed_by], references: [id])

  @@index([employee_id, start_date])
}

model leave_balances {
  id          String   @id @default(uuid())
  employee_id String
  employee    employees @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  
  year        Int
  leave_type_id String
  leave_type  leave_types @relation(fields: [leave_type_id], references: [id])
  
  total_quota Int
  used        Int      @default(0)
  remaining   Int
  
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@unique([employee_id, year, leave_type_id])
}

model overtime_requests {
  id            String         @id @default(uuid())
  request_number String         @unique
  
  employee_id   String
  employee      employees       @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  
  overtime_date DateTime
  start_time    DateTime
  end_time      DateTime
  total_hours   Float
  reason        String
  
  status        String         @default("PENDING")
  submitted_at  DateTime       @default(now())
  reviewed_at   DateTime?
  reviewed_by   String?
  review_notes  String?
  
  attendance_id String?
  
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt

  approver      users?         @relation("user_approvals_overtime", fields: [reviewed_by], references: [id])

  @@index([employee_id, overtime_date])
}

model payrolls {
  id            String   @id @default(uuid())
  payroll_number String   @unique
  
  employee_id   String
  employee      employees @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  
  month         Int
  year          Int
  
  base_salary   Float
  attendance_days Int     @default(0)
  daily_salary  Float
  
  overtime_hours Float    @default(0)
  overtime_pay   Float    @default(0)
  
  late_deduction Float    @default(0)
  absent_deduction Float   @default(0)
  
  allowances    Float    @default(0)
  deductions    Float    @default(0)
  
  gross_pay     Float
  net_pay       Float
  
  is_paid       Boolean  @default(false)
  paid_at       DateTime?
  
  slip_url      String?
  
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@unique([employee_id, month, year])
}

model notifications {
  id          String           @id @default(uuid())
  employee_id String
  employee    employees         @relation(fields: [employee_id], references: [id], onDelete: Cascade)
  
  type        String
  title       String
  message     String
  action_url  String?
  
  is_read     Boolean          @default(false)
  read_at     DateTime?
  
  created_at  DateTime         @default(now())

  @@index([employee_id])
}

model announcements {
  id          String   @id @default(uuid())
  title       String
  content     String
  priority    String   @default("NORMAL")
  
  published_at DateTime @default(now())
  expires_at   DateTime?
  
  department  String?
  is_active   Boolean  @default(true)
  
  image_url   String?
  file_url    String?
  
  view_count  Int      @default(0)
  
  created_by  String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

model payroll_periods {
  id           String    @id @default(uuid())
  period_start DateTime
  period_end   DateTime
  is_locked    Boolean   @default(false)
  locked_by    String?
  locked_at    DateTime?
  created_at   DateTime  @default(now())

  locked_by_user users?  @relation("user_locked_periods", fields: [locked_by], references: [id])
}
