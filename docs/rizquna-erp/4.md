# Rizquna ERP Master Spec v1

Dokumen ini adalah acuan tunggal implementasi MVP 90 hari untuk sistem internal PT Rizquna Pustaka.
Semua keputusan di dokumen ini menggantikan versi yang bertabrakan dari dokumen sebelumnya.

## 1) Scope Lock

### 1.1 In Scope (MVP 90 Hari)
- Master data buku dan penulis (CRUD + upload dokumen pendukung).
- Kontrak legal: upload PDF, periode berlaku, approval, rejection, expired.
- Distribusi marketplace: assignment buku ke marketplace, link produk, status posting.
- Impor penjualan (CSV) dari marketplace.
- Kalkulasi royalti per periode.
- Generasi dokumen PDF: laporan royalti dan invoice pembayaran.
- Payment tracking: status unpaid/paid.
- Dashboard KPI operasional.
- Role-based access control (Admin, Legal, Marketing, Finance).
- Audit log untuk aksi kritis.

### 1.2 Out of Scope (Pasca-MVP)
- Production planning, job order mesin cetak, dan quality control manufaktur.
- Inventory lanjutan bahan baku dan gudang multi-lokasi.
- CRM lanjutan, ticketing, marketing automation.
- Modul HR/payroll.
- Integrasi API marketplace real-time (MVP tetap CSV import).
- Mobile native app.

### 1.3 Tujuan MVP
- Mengganti proses spreadsheet manual untuk legalitas buku dan royalti.
- Menjamin perhitungan royalti dapat diaudit.
- Menyediakan visibilitas manajemen lewat dashboard dan laporan periodik.

## 2) Final Tech Decisions

### 2.1 Stack Final MVP
- Backend: Laravel 11 (PHP 8.2+).
- Admin UI: Filament v3.
- Database: PostgreSQL 16.
- Queue dan cache: Redis + Laravel Horizon.
- File storage: S3-compatible object storage.
- Workflow automation: n8n (notifikasi dan scheduler operasional).
- PDF dan Excel: Laravel DomPDF + Laravel Excel.
- Infrastruktur: Docker pada VPS Ubuntu + Nginx + SSL.

### 2.2 Alasan Keputusan
- Filament dipilih untuk kecepatan delivery modul internal.
- PostgreSQL + Redis stabil untuk transaksi dan background jobs.
- S3-compatible dipilih sebagai target final agar tidak lock-in ke Drive API.
- n8n dipakai untuk otomasi tanpa menambah kompleksitas kode aplikasi.

## 3) Final Business Rules

### 3.1 Contract Lifecycle
- `pending` -> `approved` oleh Legal/Admin.
- `pending` -> `rejected` oleh Legal/Admin.
- `approved` -> `expired` otomatis bila `end_date` terlewati.
- Buku hanya boleh didistribusikan jika kontrak status `approved`.

### 3.2 Marketplace Rules
- Assignment hanya untuk buku dengan kontrak aktif/approved.
- Posting status: `draft`, `posted`, `removed`.
- Marketing boleh ubah posting status, tidak boleh approve kontrak.

### 3.3 Sales Import Rules
- Sumber data MVP: CSV per marketplace.
- Setiap baris wajib minimal: periode, isbn/book_id, quantity, net_price.
- Quantity harus > 0.
- Baris dengan buku tanpa kontrak approved ditolak.

### 3.4 Royalty Formula MVP
- Formula dasar per baris penjualan:

`royalty_amount = quantity * net_price * (royalty_percentage / 100)`

- `net_price` pada MVP dianggap sudah setelah fee marketplace.
- Agregasi royalti dilakukan per penulis per periode.

### 3.5 Payment Lifecycle
- `draft` (hasil hitung) -> `finalized` (disetujui Finance) -> `paid` (dibayar).
- Invoice hanya bisa dibuat dari kalkulasi status `finalized`.

## 4) Final Data Model v1

### 4.1 Tabel Inti
- `users`: data akun internal.
- `roles`, `permissions`, `model_has_roles`: RBAC.
- `authors`: profil penulis, data bank, NPWP.
- `books`: metadata buku, ISBN, harga dasar, cover.
- `book_author`: relasi many-to-many buku-penulis.
- `contracts`: kontrak legal per buku.
- `marketplaces`: master marketplace.
- `assignments`: assignment buku ke marketplace.
- `sales`: data penjualan per periode.
- `royalty_calculations`: header kalkulasi royalti.
- `royalty_items`: detail royalti per buku/penulis.
- `payments`: riwayat pembayaran royalti.
- `activity_log`: audit log perubahan data.

### 4.2 Constraint Wajib
- `books.isbn` unique (nullable allowed jika buku belum ber-ISBN).
- `contracts.start_date < contracts.end_date`.
- `contracts.royalty_percentage` antara 0 sampai 100.
- Satu buku tidak boleh punya lebih dari satu kontrak `approved` aktif pada waktu yang sama.
- `sales.quantity > 0` dan `sales.net_price >= 0`.

### 4.3 Index Wajib
- `books(isbn)`.
- `contracts(status, end_date)`.
- `sales(period_start, period_end)`.
- `sales(book_id, marketplace_id)`.
- `royalty_calculations(author_id, period_start, period_end)`.

## 5) API Contract v1 (MVP)

### 5.1 Endpoint Prioritas
- `POST /api/v1/contracts` upload kontrak.
- `PUT /api/v1/contracts/{id}/approve` approve kontrak.
- `PUT /api/v1/contracts/{id}/reject` reject kontrak.
- `POST /api/v1/sales/import` impor CSV penjualan.
- `POST /api/v1/royalties/calculate` hitung royalti per periode.
- `PUT /api/v1/royalties/{id}/finalize` finalisasi kalkulasi.
- `POST /api/v1/royalties/{id}/invoice` generate invoice PDF.
- `PUT /api/v1/payments/{id}/mark-paid` tandai pembayaran.

### 5.2 Standar Response
- Success: `{ "success": true, "data": ... }`
- Error validasi: HTTP 422 dengan daftar field error.
- Error bisnis: HTTP 409 untuk konflik aturan (mis. kontrak belum approved).

## 6) Security, Compliance, dan Operasional

### 6.1 RBAC Ringkas
- Admin: full access + user management.
- Legal: kontrak, approval, dokumen legal.
- Marketing: assignment marketplace dan status posting.
- Finance: sales import, royalty calc, payment, invoice.

### 6.2 Audit dan Compliance
- Semua create/update/delete/status change di modul kritis wajib dicatat.
- Audit mencakup `user`, `timestamp`, `old_values`, `new_values`, `ip_address`.
- Dokumen kontrak disimpan sebagai arsip digital dengan backup harian off-site.

### 6.3 Backup dan Recovery
- Backup database harian.
- Backup file storage harian.
- Uji restore minimal per kuartal.

## 7) Roadmap Implementasi MVP (90 Hari)

### Fase 0 (Minggu 1-2): Foundation
- Setup environment Docker, VPS, SSL.
- Setup Laravel, Filament, PostgreSQL, Redis.
- Setup RBAC baseline dan audit log.

### Fase 1 (Minggu 3-5): Master Data
- Modul authors, books, marketplace.
- Upload cover/KTP.
- Validasi ISBN dan relasi buku-penulis.

### Fase 2 (Minggu 6-8): Legal & Distribution
- Modul contracts + workflow approve/reject/expire.
- Assignment marketplace untuk buku approved.
- Widget reminder kontrak akan habis.

### Fase 3 (Minggu 9-11): Sales, Royalty, Payment
- Impor sales CSV + validasi.
- Royalty engine + detail per periode.
- Invoice PDF + payment tracking.

### Fase 4 (Minggu 12-13): Dashboard, Reports, Stabilization
- KPI dashboard.
- Export laporan PDF/Excel.
- UAT, bugfix, hardening, go-live checklist.

## 8) UAT dan Go-Live Checklist

### 8.1 UAT Minimum
- Buku dan penulis bisa CRUD tanpa error.
- Kontrak bisa upload, approve, reject, auto-expire.
- Assignment marketplace menolak buku tanpa kontrak approved.
- Import sales valid sukses, invalid ditolak jelas.
- Royalti periode terhitung sesuai formula.
- Invoice PDF bisa diunduh dan payment bisa ditandai paid.

### 8.2 Go-Live
- Freeze perubahan data di spreadsheet lama.
- Jalankan migrasi data final.
- Verifikasi sampling data bersama user bisnis.
- Aktifkan monitoring log dan error tracking.
- Hypercare 14 hari pasca go-live.

## 9) Open Decisions (Harus Diputuskan)

- D1. Co-author di MVP: didukung atau ditunda?
  Dampak: desain final `book_author` dan logika split royalti.
- D2. Pajak royalti di MVP: dihitung otomatis atau manual?
  Dampak: formula perhitungan, field data, template invoice.
- D3. Retur/refund pada MVP: dimasukkan atau ditunda?
  Dampak: struktur `sales.status` dan kalkulasi royalti bersih.
- D4. Template kontrak: upload-only atau generate dari sistem?
  Dampak: effort modul document generation.
- D5. Frekuensi pembayaran royalti: bulanan atau kuartalan?
  Dampak: periodisasi perhitungan dan jadwal operasional Finance.

---

Status dokumen: FINAL DRAFT untuk eksekusi teknis MVP.
